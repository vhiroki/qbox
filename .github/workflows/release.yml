name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.1.0, v1.0.0, etc.
  workflow_dispatch:  # Allow manual triggering from GitHub Actions UI
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0) - leave empty to use package.json version'
        required: false
        type: string
      skip_tests:
        description: 'Skip tests (use with caution)'
        required: false
        type: boolean
        default: false

# Cancel in-progress runs for the same tag
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # Required for creating releases

jobs:
  # Run tests before building
  test:
    name: Run Tests
    if: ${{ !inputs.skip_tests }}
    uses: ./.github/workflows/test.yml

  build:
    needs: [test]
    # Run build even if test job was skipped (when skip_tests is true)
    if: ${{ always() && (needs.test.result == 'success' || needs.test.result == 'skipped') }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
            arch: arm64
          - os: macos-15-intel  # Intel Mac (macos-13 deprecated)
            platform: macos
            arch: x64
          - os: windows-latest
            platform: windows
            arch: x64

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv (Python package manager)
        uses: astral-sh/setup-uv@v4

      # ========== Backend Build ==========
      - name: Install backend dependencies
        working-directory: backend
        run: |
          uv sync
          uv pip install pyinstaller

      - name: Build backend with PyInstaller
        working-directory: backend
        run: uv run python build.py
        env:
          PYTHONIOENCODING: utf-8

      - name: Verify backend build (macOS/Linux)
        if: runner.os != 'Windows'
        run: ls -la backend/dist/qbox-backend

      - name: Verify backend build (Windows)
        if: runner.os == 'Windows'
        run: dir backend\dist\qbox-backend.exe
        shell: cmd

      # ========== Frontend Build ==========
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Package Electron app
        working-directory: frontend
        run: npm run make
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Code signing credentials for macOS
          APPLE_ID: ${{ vars.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          APPLE_IDENTITY: ${{ vars.APPLE_IDENTITY }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}

      # ========== Generate Update Metadata ==========
      - name: Generate update metadata (macOS/Linux)
        if: runner.os != 'Windows'
        run: |
          chmod +x scripts/generate-update-yml.sh
          ./scripts/generate-update-yml.sh

      - name: Generate update metadata (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Get version from package.json
          $version = (Get-Content frontend/package.json | ConvertFrom-Json).version
          $outDir = "frontend/out/make/squirrel.windows/x64"
          
          # Find the setup exe and nupkg files
          $setupExe = Get-ChildItem -Path $outDir -Filter "*.exe" | Select-Object -First 1
          $nupkg = Get-ChildItem -Path $outDir -Filter "*.nupkg" | Select-Object -First 1
          
          if ($setupExe -and $nupkg) {
            # Generate latest.yml for Windows auto-updates
            $yamlContent = @"
          version: $version
          files:
            - url: $($setupExe.Name)
              sha512: $((Get-FileHash -Path $setupExe.FullName -Algorithm SHA512).Hash.ToLower())
              size: $($setupExe.Length)
          path: $($setupExe.Name)
          sha512: $((Get-FileHash -Path $setupExe.FullName -Algorithm SHA512).Hash.ToLower())
          releaseDate: $(Get-Date -Format "yyyy-MM-ddTHH:mm:ss.fffZ")
          "@
            $yamlContent | Out-File -FilePath "$outDir/latest.yml" -Encoding utf8
            Write-Host "Generated latest.yml for Windows"
          } else {
            Write-Host "Warning: Could not find setup exe or nupkg files"
          }

      # ========== Upload Artifacts ==========
      - name: Upload macOS artifacts
        if: matrix.platform == 'macos'
        uses: actions/upload-artifact@v4
        with:
          name: qbox-macos-${{ matrix.arch }}
          path: |
            frontend/out/make/**/*.dmg
            frontend/out/make/**/*.zip
            frontend/out/make/**/*.yml
          if-no-files-found: error

      - name: Upload Windows artifacts
        if: matrix.platform == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: qbox-windows-${{ matrix.arch }}
          path: |
            frontend/out/make/squirrel.windows/**/*.exe
            frontend/out/make/squirrel.windows/**/*.nupkg
            frontend/out/make/squirrel.windows/**/*.yml
            frontend/out/make/squirrel.windows/**/RELEASES
          if-no-files-found: error

  # ========== Create GitHub Release ==========
  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release-files

          # ========== macOS Artifacts ==========
          for dir in artifacts/qbox-macos-*; do
            if [ -d "$dir" ]; then
              arch=$(basename "$dir" | sed 's/qbox-macos-//')

              # Find and copy DMG files
              find "$dir" -name "*.dmg" -exec sh -c '
                for f; do
                  base=$(basename "$f" .dmg)
                  cp "$f" "release-files/${base}-'$arch'.dmg"
                done
              ' sh {} +

              # Find and copy ZIP files (required for auto-updates)
              # Note: ZIP files already include architecture in their name from Forge
              find "$dir" -name "*.zip" -exec cp {} release-files/ \;

              # Copy YML files (use arm64 version as the main one for macOS)
              if [ "$arch" = "arm64" ]; then
                find "$dir" -name "latest-mac.yml" -exec cp {} release-files/ \; 2>/dev/null || true
                find "$dir" -name "*.yml" -exec cp {} release-files/ \; 2>/dev/null || true
              fi
            fi
          done

          # ========== Windows Artifacts ==========
          for dir in artifacts/qbox-windows-*; do
            if [ -d "$dir" ]; then
              arch=$(basename "$dir" | sed 's/qbox-windows-//')

              # Copy Windows setup exe
              find "$dir" -name "*.exe" -exec cp {} release-files/ \;

              # Copy nupkg for delta updates
              find "$dir" -name "*.nupkg" -exec cp {} release-files/ \;

              # Copy RELEASES file for Squirrel
              find "$dir" -name "RELEASES" -exec cp {} release-files/ \;

              # Copy latest.yml for Windows auto-updates
              find "$dir" -name "latest.yml" -exec cp {} release-files/ \; 2>/dev/null || true
            fi
          done

          echo "Files to release:"
          ls -la release-files/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input or read from package.json
            if [ -n "${{ inputs.version }}" ]; then
              echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            else
              VERSION=$(jq -r .version frontend/package.json)
              echo "version=$VERSION" >> $GITHUB_OUTPUT
            fi
          else
            # Tag trigger - extract version from tag
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: QBox v${{ steps.version.outputs.version }}
          draft: true  # Create as draft so you can review before publishing
          generate_release_notes: true
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "## ðŸŽ‰ Release Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Version: **v${{ steps.version.outputs.version }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          ls release-files/ | while read f; do echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY; done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to [Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the draft release" >> $GITHUB_STEP_SUMMARY
          echo "3. Edit release notes if needed" >> $GITHUB_STEP_SUMMARY
          echo "4. Click **Publish release**" >> $GITHUB_STEP_SUMMARY
